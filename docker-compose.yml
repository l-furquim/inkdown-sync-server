version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - ENV=development
      - DB_HOST=couchdb
      - DB_PORT=5984
      - DB_USER=admin
      - DB_PASSWORD=password
      - DB_NAME=inkdown
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - JWT_EXPIRATION=15m
      - REFRESH_TOKEN_EXPIRATION=168h
      - WS_READ_BUFFER_SIZE=4096
      - WS_WRITE_BUFFER_SIZE=4096
      - WS_MAX_MESSAGE_SIZE=10485760
      - RATE_LIMIT_REQUESTS_PER_MINUTE=60
      - CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
      - LOG_LEVEL=debug
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - inkdown-network
    restart: unless-stopped

  couchdb:
    image: couchdb:3.3
    ports:
      - "5984:5984"
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=password
    volumes:
      - couchdb_data:/opt/couchdb/data
    networks:
      - inkdown-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  couchdb_data:
    driver: local

networks:
  inkdown-network:
    driver: bridge
